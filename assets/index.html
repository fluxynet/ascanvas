<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>ASCII Canvas</title>
	<style>
      body {
          color: #333;
          font-family: monospace;
      }

      .button {
          border: 1px solid #c0c0c0;
          background: #c4c4c4;
          width: 11em;
          padding: 10px;
          text-align: center;
          cursor: pointer;
          margin: 4px 2px;
          display: block;
          border-radius: 0.5em;
          font-size: 1.1em;
      }

      .button:hover {
          background: #fff;
      }

      table {
          border-collapse: collapse;
      }

      table, tr, th, td {
          border: 1px solid #999;
      }

      tbody tr:hover {
          background-color: #c0c0c0;
      }

      th, td {
          padding: 20px;
      }

      td {
          color: #333;
          border: 1px solid #c4c4c4c4;
          cursor: pointer;
      }

	</style>
</head>
<body>
<div id="app">
	<?xml version="1.0" encoding="utf-8"?>
	<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="margin: auto; background: rgba(0, 0, 0, 0) none repeat scroll 0% 0%; display: block; shape-rendering: auto;" width="200px" height="200px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
		<rect x="19" y="19" width="20" height="20" fill="#93dbe9">
			<animate attributeName="fill" values="#689cc5;#93dbe9;#93dbe9" keyTimes="0;0.125;1" dur="1s" repeatCount="indefinite" begin="0s" calcMode="discrete"></animate>
		</rect><rect x="40" y="19" width="20" height="20" fill="#93dbe9">
		<animate attributeName="fill" values="#689cc5;#93dbe9;#93dbe9" keyTimes="0;0.125;1" dur="1s" repeatCount="indefinite" begin="0.125s" calcMode="discrete"></animate>
	</rect><rect x="61" y="19" width="20" height="20" fill="#93dbe9">
		<animate attributeName="fill" values="#689cc5;#93dbe9;#93dbe9" keyTimes="0;0.125;1" dur="1s" repeatCount="indefinite" begin="0.25s" calcMode="discrete"></animate>
	</rect><rect x="19" y="40" width="20" height="20" fill="#93dbe9">
		<animate attributeName="fill" values="#689cc5;#93dbe9;#93dbe9" keyTimes="0;0.125;1" dur="1s" repeatCount="indefinite" begin="0.875s" calcMode="discrete"></animate>
	</rect><rect x="61" y="40" width="20" height="20" fill="#93dbe9">
		<animate attributeName="fill" values="#689cc5;#93dbe9;#93dbe9" keyTimes="0;0.125;1" dur="1s" repeatCount="indefinite" begin="0.375s" calcMode="discrete"></animate>
	</rect><rect x="19" y="61" width="20" height="20" fill="#93dbe9">
		<animate attributeName="fill" values="#689cc5;#93dbe9;#93dbe9" keyTimes="0;0.125;1" dur="1s" repeatCount="indefinite" begin="0.75s" calcMode="discrete"></animate>
	</rect><rect x="40" y="61" width="20" height="20" fill="#93dbe9">
		<animate attributeName="fill" values="#689cc5;#93dbe9;#93dbe9" keyTimes="0;0.125;1" dur="1s" repeatCount="indefinite" begin="0.625s" calcMode="discrete"></animate>
	</rect><rect x="61" y="61" width="20" height="20" fill="#93dbe9">
		<animate attributeName="fill" values="#689cc5;#93dbe9;#93dbe9" keyTimes="0;0.125;1" dur="1s" repeatCount="indefinite" begin="0.5s" calcMode="discrete"></animate>
	</rect>
	<!-- [ldio] generated by https://loading.io/ --></svg>
</div>
<script type="module">
	import {html, render} from 'https://unpkg.com/lit-element/lit-element.js?module';

	const app = document.getElementById('app');
	const state = {
		route: 'list',
		listing: [],
		canvas: {
			name: '',
			content: '',
		},
		watcher: null,
	};

	const listCanvas = async (state) => {
		try {
			state.listing = await fetch('/api').then(r => r.json());
		} catch (e) {
			alert('An error occurred while fetching the list: ' + e.message);
		}
	};

	const showList = async (state) => {
		state.route = 'list';
		window.history.pushState('list', 'ASCII Canvas - Listing', '/');

		if (state.watcher !== null) {
			state.watcher.close();
			state.watcher = null;
		}

		render(view(state), app);
	};

	const showListWithReload = async (state) => {
		await listCanvas(state);
		await showList(state);
	};

	const watch = (id) => {
		if (!id) {
			return;
		}

		state.watcher = new EventSource(`/api/${id}/events`);
		state.watcher.onerror = console.error;
		state.watcher.onmessage = console.log;

		state.watcher.addEventListener('UPDATED', ({data}) => {
			state.canvas = JSON.parse(data);
			render(view(state), app);
		});

		state.watcher.addEventListener('DELETED', () => {
			alert('The canvas has been deleted. Updates will be stopped.');
			state.watcher.close();
			state.watcher = null;
		});
	};

	const showCanvas = (state, canvas) => {
		state.canvas = canvas;
		state.route = 'canvas';
		window.history.pushState(canvas.id, `ASCII Canvas - ${canvas.name}`, canvas.id);

		watch(canvas.id);

		render(view(state), app);
		return false;
	};

	const prettifyCanvas = (canvas) => {
		let grid = '';

		for (let c = canvas.content; c !== "";) {
			grid += c.substr(0, canvas.width) + '\n';
			c = c.substr(canvas.width);
		}
		return grid;
	};

	const view = (state) => {
		if (state.route === 'canvas') {
			return html`
				<div><span class="button" @click=${() => showListWithReload(state)}>&larr; Back to listing</span></div>
				<h1>Canvas: ${state.canvas.name}</h1>
				<div>
					<p><strong>ID: </strong>${state.canvas.id}</p>
					<p><strong>Name: </strong>${state.canvas.name}</p>
					<p><strong>Width: </strong>${state.canvas.width}</p>
					<p><strong>Height: </strong>${state.canvas.height}</p>
					<p><strong>Watching: </strong>${state.watcher ? 'On' : 'Off'}</p>
				</div>
				<pre>${prettifyCanvas(state.canvas)}</pre>
			`;
		}

		return html`
			<div><span class="button" @click=${() => window.location = '/swagger/index.html'}>Swagger UI</span>
			</div>
			<h1>Canvas Listing</h1>
			<table>
				<thead>
				<tr>
					<th>ID</th>
					<th>Height</th>
					<th>Width</th>
					<th>Name</th>
				</tr>
				</thead>
				<tbody>
				${state.listing.map(canvas => html`
					<tr @click="${() => showCanvas(state, canvas)}">
						<td>${canvas.id}</td>
						<td>${canvas.height}</td>
						<td>${canvas.width}</td>
						<td>${canvas.name}</td>
					</tr>
				`)}
				</tbody>
			</table>
		`;
	};

	(async function() {
		await listCanvas(state);
		app.innerHTML = '';

		if (window.location.pathname.length === 37) {
			const id = window.location.pathname.substring(1);
			const canvas = state.listing.find((canvas) => canvas.id === id);
			if (canvas) {
				showCanvas(state, canvas);
				return;
			}
		}
		
		await showList(state);
	}());

</script>
</body>
</html>